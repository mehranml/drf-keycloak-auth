image: python:3.9

stages:
  - Static Analysis
  - Bootstrap
  - sonar
  - Build
  - Publish

linting:
  stage: Static Analysis
  before_script:
    - python --version
    - pip install pycodestyle
  script:
    - pycodestyle --format=pylint drf_keycloak_auth/

venv:
  stage: Bootstrap
  script:
    - make install-dependencies
  artifacts:
    when: on_success
    expire_in: 1 hour
    paths:
      - venv/
  only:
    refs:
      - tags
      - master

build:
  stage: Build
  script:
    - make
  dependencies:
    - venv
  artifacts:
    when: on_success
    expire_in: 6 mos
    paths:
      - dist/
  only:
    refs:
      - tags
      - master

pypi:
  stage: Publish
  variables:
    TWINE_USERNAME: ${TWINE_USERNAME}
    TWINE_PASSWORD: ${TWINE_PASSWORD}
  script:
    - make publish-pypi
  only:
    refs:
      - tags

sonarqube-check:
  stage: sonar
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  before_script: []
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"'
      exists:
        - sonar-project.properties
      when: always
    - when: never
